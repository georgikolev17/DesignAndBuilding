@using DesignAndBuilding.Web.ViewModels.Assignment
@using DesignAndBuilding.Common
@model AssignmentDetailsViewModel
@{
    int i = 0;
    this.ViewData["Title"] = "Детайли на заданието";

    const int maxLen = 150;
    var fullText = Model.DescriptionText ?? "Няма";
    var shortText = fullText;

    if (fullText.Length > maxLen)
    {
        shortText = fullText.Substring(0, maxLen) + "...";
    }
}
<div id="alert"></div>
<div class="container-fluid">
    <div class="row w-100 m-0">
        <div class="card shadow mb-1 w-40 align-self-start">
            <div class="card-header py-3">
                <h5 class="m-0 font-weight-bold text-primary">Обект</h5>
            </div>
            <div class="card-body">
                <p><b>Име: </b>@Model.Building.Name</p>
                <p><b>РЗП:</b> @Model.Building.TotalBuildUpArea</p>
                <p><b>Тип: </b>@Model.Building.BuildingType.GetDisplayName()</p>
                <p><b>Създател: </b>@Model.ArchitectName</p>
                <h6 class="text-primary font-weight-bold mb-3">Задание</h6>

                <div class="assignment-section">
                    <p>
                        <b>Описание: </b>
                        <a href="/assignments/download/@Model.AssignmentId">Изтегли</a>
                    </p>
                    <p><b>Част: </b>@Model.UserType.GetDisplayShortName()</p>
                    <p><b>Краен срок: </b>@Model.EndDate.ToString("dd.MM.yyyy г. HH:mm")</p>
                    <p><b>Дата на създаване: </b>@Model.CreatedOn.ToString("dd.MM.yyyy г.")</p>
                    <p>
                        <b>Текстово описание: </b>
                        @shortText

                        @if (fullText.Length > maxLen)
                        {
                            <a href="#" data-toggle="modal" data-target="#descriptionModal">
                                Прочети още
                            </a>
                        }
                    </p>
                </div>
                @if (!Model.IsFinished && !Model.HasUserCreatedAssignment)
                {
                    <hr class="m-2"/>
                    <div class="card border-left-primary shadow w-100 mt-3">
                        <div class="card-body py-1 ">
                            <form method="post" class="mb-0">
                                <div asp-validation-summary="All" class="text-danger mb-2"></div>

                                <div class="form-inline">
                                    <label asp-for="@Model.BidPrice" class="mr-2"></label>
                                    <input asp-for="@Model.BidPrice" class="form-control w-50" />
                                </div>

                                <button type="submit" class="btn btn-primary m-1">Предложи оферта</button>
                            </form>
                        </div>

                    </div>
                }
            </div>
        </div>
        <div class="ml-3 w-55 mb-1">
            <div class="card shadow">

                <!-- Card Header -->
                <div class="card-header py-3 text-center">
                    <h4 class="m-0 font-weight-bold text-primary">Оферти</h4>
                </div>

                <!-- Card Body -->
                <div class="card-body">

                    <table class="table table-hover text-center mb-4" id="bids">
                        @foreach (var bid in Model.Bids)
                        {
                            i++;
                            <tr>
                                <td>@i</td>

                                @if (Model.IsFinished && Model.HasUserCreatedAssignment)
                                {
                                    <td>@bid.UserFullName</td>
                                    <td>@bid.PhoneNumber</td>
                                    <td>@bid.Email</td>
                                }
                                else
                                {
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                }

                                <td>@bid.Price лв/кв.м</td>

                                @if (Model.IsFinished && Model.HasUserCreatedAssignment)
                                {
                                    <td></td>
                                }
                                else
                                {
                                    <td>@bid.TimePlaced</td>
                                }
                            </tr>
                        }
                    </table>
                </div>

            </div>
        </div>

    </div>
</div>

<hr />

<!-- Q&A section -->
<div class="container mt-4" id="qanda-section">
    <h4 class="text-center">Въпроси и отговори</h4>

    @* Show question form only for engineers (non-creators) and only while the assignment is open *@
    @if (!Model.IsFinished && !Model.HasUserCreatedAssignment)
    {
        <form id="askQuestionForm" class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Задай въпрос към възложителя</h5>
                <div class="form-group">
                    <textarea name="text" id="questionText" class="form-control" rows="3"
                          placeholder="Напиши своя въпрос тук..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">
                    Изпрати въпрос
                </button>
            </div>
        </form>
    }

    <div id="questionsContainer">
        @if (Model.Questions != null && Model.Questions.Any())
        {
            <ul class="list-group" id="questionsList">
                @foreach (var q in Model.Questions)
                {
                    <li class="list-group-item mb-2" data-question-id="@q.Id">
                        <div>
                            <strong>Въпрос:</strong> @q.Text<br />
                            <small class="text-muted">
                                Зададен от: @q.EngineerName на @q.CreatedOn.ToString("dd.MM.yyyy г. HH:mm")
                            </small>
                        </div>

                        <div class="mt-2">

                            @if (!string.IsNullOrEmpty(q.AnswerText))
                            {
                                <div class="p-2 bg-light border rounded">
                                    <strong>Отговор:</strong>
                                    <span class="answer-text">@q.AnswerText</span>
                                    <br />
                                    <small class="text-muted">
                                        От: @q.AnswerArchitectName
                                        @if (q.AnswerCreatedOn.HasValue)
                                        {
                                            @: на @q.AnswerCreatedOn.Value.ToString("dd.MM.yyyy г. HH:mm")
                                        }
                                    </small>
                                </div>
                            }
                            else
                            {
                                <div class="p-2 bg-light border rounded">
                                    <span class="answer-text text-muted">Все още няма отговор.</span>
                                </div>

                                @* Show answer form only for the architect *@
                                @if (Model.HasUserCreatedAssignment && !Model.IsFinished)
                                {
                                    <form class="answerForm mt-2" enctype="multipart/form-data">
                                        <textarea name="text" class="form-control answer-input" rows="2"
                                  placeholder="Напиши отговор..."></textarea>
                                        <button type="submit" class="btn btn-sm btn-success mt-1">
                                            Изпрати отговор
                                        </button>
                                    </form>
                                }
                            }

                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted">Все още няма зададени въпроси.</p>
        }
    </div>
</div>
<partial name="_DescriptionModal" model="@Model.DescriptionText">
<script src="~/js/bids.js" asp-append-version="true"></script>

@section Scripts {
    <script>
        (function () {
            const assignmentId = @Model.AssignmentId;
            const alertDiv = document.getElementById('alert');

            // Show success/error message
            function showAlert(message, isSuccess) {
                alertDiv.innerHTML =
                    `<div class="alert alert-${isSuccess ? 'success' : 'danger'}" role="alert">${message}</div>`;
            }

            // -----------------------------
            //   ASK QUESTION (ENGINEER)
            // -----------------------------
            const askForm = document.getElementById("askQuestionForm");
            if (askForm) {
                askForm.addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const text = document.getElementById("questionText").value.trim();
                    if (!text) {
                        showAlert("Моля, въведете текст на въпроса.", false);
                        return;
                    }

                    const response = await fetch('/api/qanda/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ assignmentId: assignmentId, text: text })
                    });

                    if (!response.ok) {
                        showAlert(await response.text(), false);
                        return;
                    }

                    const result = await response.json();

                    // Append the new question to the list
                    let list = document.getElementById("questionsList");
                    if (!list) list = createQuestionsList();

                    const li = document.createElement("li");
                    li.className = "list-group-item mb-2";
                    li.innerHTML = `
                        <div>
                            <strong>Въпрос:</strong> ${result.text}<br />
                            <small class="text-muted">Току-що зададен от вас.</small>
                        </div>
                        <div class="mt-2">
                            <div class="p-2 bg-light border rounded">
                                <strong>Отговор:</strong>
                                <span class="answer-text text-muted">Все още няма отговор.</span>
                            </div>
                        </div>`;

                    list.insertBefore(li, list.firstChild);
                    askForm.reset();
                    showAlert("Въпросът беше изпратен успешно.", true);
                });
            }

            // Create list when first question is added
            function createQuestionsList() {
                const container = document.getElementById("questionsContainer");
                container.innerHTML = "";
                const ul = document.createElement("ul");
                ul.className = "list-group";
                ul.id = "questionsList";
                container.appendChild(ul);
                return ul;
            }

            // -----------------------------
            //   SUBMIT ANSWER (ARCHITECT)
            // -----------------------------
            const questionsList = document.getElementById("questionsList");
            if (questionsList) {
                questionsList.addEventListener("submit", async function (e) {
                    const form = e.target.closest(".answerForm");
                    if (!form) return;

                    e.preventDefault();

                    const li = form.closest("li[data-question-id]");
                    const questionId = parseInt(li.dataset.questionId);
                    const answerText = form.querySelector(".answer-input").value.trim();

                    if (!answerText) {
                        showAlert("Моля, въведете текст на отговора.", false);
                        return;
                    }

                    const response = await fetch('/api/qanda/answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ questionId: questionId, text: answerText })
                    });

                    if (!response.ok) {
                        showAlert(await response.text(), false);
                        return;
                    }

                    const result = await response.json();

                    // Update the UI
                    const answerSpan = li.querySelector(".answer-text");
                    answerSpan.textContent = result.text;
                    answerSpan.classList.remove("text-muted");

                    form.remove();
                    showAlert("Отговорът беше изпратен успешно.", true);
                });
            }

        })();
    </script>
}
